#!/bin/bash

source "${deps}/pkg/common"

src=glew-1.11.0.tgz
sha1=9bb5c87c055acd122a4956112bbb18ee72c38e5c
url="http://download.sourceforge.net/glew/${src}"

fetch $src $sha1 $url

mkdir ${work}
cd ${work}
tar xf "${files}/${src}"
cd glew-*

sed \
	-e "s|i586-mingw32msvc-gcc|${CC}|g" \
	-e "s|i586-mingw32msvc-ld|${LD}|g" \
	-e "s/GLEW_BUILD/GLEW_STATIC/g" \
	< config/Makefile.linux-mingw32 > config/Makefile.custom

# don't build DLL
sed \
	-e 's/lib lib\/$(LIB.SHARED)/lib/' \
	< Makefile > Makefile.custom

echo "AR = ${AR}" >> config/Makefile.custom
echo "STRIP = ${STRIP}" >> config/Makefile.custom

SYSTEM=custom GLEW_DEST=${prefix} make -f Makefile.custom ${MAKEFLAGS} \
	CFLAGS="${CFLAGS} -Iinclude" \
	LDFLAGS.EXTRA="${LDFLAGS_NOWL}" \
	glew.lib \
	install.include \
	install.pkgconfig

# install the static lib
install -c -m 644 lib/libglew32.a ${prefix}/lib/

cat >> ${prefix}/deps.cmake << EOF
set(GLEW_INCLUDE_DIR "${prefix}/include" CACHE PATH "")
set(GLEW_LIBRARY "${prefix}/lib/libglew32.a" CACHE FILEPATH "")
EOF

cd "${deps}"; rm -rf "${work}"
