#!/bin/bash

source "${deps}/pkg/common"

src=opus-1.1.1.tar.gz
sha1=33f83cdccc36e875fea378425003bba448b15b8b
url="http://downloads.xiph.org/releases/opus/${src}"

fetch $src $sha1 $url

mkdir ${work}
cd ${work}
tar xf "${files}/${src}"
cd opus-*

# libopus symbols get exported from the executable with static linking
# fix that junk
sed -i -e "s/__declspec(dllexport)//" include/opus_defines.h

./configure \
	--prefix=${prefix} \
	--host=${host_triplet} \
	--disable-shared \
	--disable-doc \
	--disable-extra-programs \
	--disable-silent-rules \
	--enable-intrinsics \
	--enable-rtcd \
	LDFLAGS="-L${prefix}/lib ${LDFLAGS}" \
	CPPFLAGS="-I${prefix}/include"

make ${MAKEFLAGS} install

cat >> ${prefix}/deps.cmake << EOF
set(Opus_INCLUDE_DIR "${prefix}/include/opus" CACHE PATH "")
set(Opus_LIBRARY "${prefix}/lib/libopus.a" CACHE FILEPATH "")
EOF

cd "${deps}"; rm -rf "${work}"
