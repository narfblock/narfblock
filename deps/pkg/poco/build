#!/bin/bash

source "${deps}/pkg/common"

src=poco-1.4.6p4.tar.gz
sha1=49fc64bc23928d947fc8445e4e667f335bbe4274
url="http://pocoproject.org/releases/poco-1.4.6/${src}"

fetch $src $sha1 $url

mkdir ${work}
cd ${work}
tar xf "${files}/${src}"
cd poco-*

case "${host_triplet}" in
*mingw*)
    config=MinGW-custom
    makefile=build/config/${config}
    sed \
        -e 's/-mno-cygwin//g' \
        -e "s/i686-pc-mingw32/${host_triplet}/g" \
        -e "s|-O2|${CFLAGS}|g" \
        -e "s|\$(CROSSENV)-ar|${AR}|" \
        -e "s|\$(CROSSENV)-ranlib|${RANLIB}|" \
        < build/config/MinGW-CrossEnv > ${makefile}

    sed -i \
        -e 's/_MSC_VER/_WIN32/' \
        -e 's/__int64/long long/' \
        Foundation/include/Poco/Types.h
    ;;
*)
    config=Linux-custom
    makefile=build/config/${config}
    sed \
        -e "s/gcc\$/${CC}/g" \
        -e "s/g++\$/${CXX}/g" \
        -e "s/strip\$/${STRIP}/g" \
        -e "s/ranlib\$/${RANLIB}/g" \
        -e "s/-ldl//g" \
        < build/config/Linux > ${makefile}
    ;;
esac

cat >>Foundation/include/Poco/Config.h <<EOF
    #define POCO_NO_FILECHANNEL
    #define POCO_NO_SPLITTERCHANNEL
    #define POCO_NO_SYSLOGCHANNEL
    #define POCO_UTIL_NO_XMLCONFIGURATION
EOF

./configure --host=${host_triplet} --prefix=${prefix} --config=${config}

make ${MAKEFLAGS} LINKMODE=STATIC install

cat >> ${prefix}/deps.cmake << EOF
set(PocoFoundation_INCLUDE_DIR "${prefix}/include" CACHE PATH "")
set(PocoFoundation_LIBRARY "${prefix}/lib/libPocoFoundation.a" CACHE FILEPATH "")
set(PocoUtil_INCLUDE_DIR "${prefix}/include" CACHE PATH "")
set(PocoUtil_LIBRARY "${prefix}/lib/libPocoUtil.a" CACHE FILEPATH "")
EOF

cd "${deps}"; rm -rf "${work}"
